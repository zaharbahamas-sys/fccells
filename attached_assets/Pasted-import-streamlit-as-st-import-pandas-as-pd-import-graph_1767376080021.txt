import streamlit as st
import pandas as pd
import graphviz
import numpy as np

# --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="FCPMS Ultimate - Ù†Ø¸Ø§Ù… Ø§Ù„Ø·Ø§Ù‚Ø©", layout="wide", page_icon="ğŸ”‹")

# --- 1. Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Data Structure) ---
class FuelCell:
    def __init__(self, name, technology, efficiency, min_power, max_power, fuel_type, lhv, capex_per_kw, source_name, source_link):
        self.name = name
        self.technology = technology
        self.efficiency = efficiency
        self.min_power = min_power
        self.max_power = max_power
        self.fuel_type = fuel_type
        self.lhv = lhv
        self.capex_per_kw = capex_per_kw  # ØªÙƒÙ„ÙØ© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© Ù„Ù„ÙƒÙŠÙ„ÙˆÙˆØ§Ø· (USD)
        self.source_name = source_name
        self.source_link = source_link

# Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙƒÙ„ÙØ© ØªÙ‚Ø¯ÙŠØ±ÙŠØ© CAPEX Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)
inventory = [
    FuelCell("Ballard FCgen-H2PM", "PEMFC", 0.52, 1.0, 15.0, "Hydrogen", 33.3, 3000, "Ballard Datasheets", "https://www.ballard.com/fuel-cell-solutions/backup-power"),
    FuelCell("Plug Power GenSure", "PEMFC", 0.50, 0.5, 10.0, "Hydrogen", 33.3, 3200, "Plug Power Catalog", "https://www.plugpower.com/products/gensure/"),
    FuelCell("SFC EFOY Pro", "DMFC", 0.38, 0.05, 0.5, "Methanol", 5.5, 4000, "SFC Energy Specs", "https://www.sfc.com/en/clean-energy/efoy-pro/"),
    FuelCell("Bloom Energy Server", "SOFC", 0.60, 50.0, 300.0, "Nat Gas/H2", 13.9, 2500, "Bloom Energy Tech", "https://www.bloomenergy.com/technology/"),
]

# --- 2. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) ---
st.sidebar.image("https://cdn-icons-png.flaticon.com/512/3135/3135706.png", width=80)
st.sidebar.title("Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")

# Ù…Ø¯Ø®Ù„Ø§Øª ÙÙ†ÙŠØ©
st.sidebar.subheader("âš™ï¸ Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„ÙÙ†ÙŠØ©")
load_kw = st.sidebar.number_input("Ø­Ù…Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (kW)", 0.1, 500.0, 5.0)
hours_per_year = st.sidebar.number_input("Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ Ø³Ù†ÙˆÙŠØ§Ù‹", 1, 8760, 2000, help="ÙƒÙ… Ø³Ø§Ø¹Ø© ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…ÙˆÙ„Ø¯/Ø§Ù„Ø®Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ù†Ø©ØŸ")

# Ù…Ø¯Ø®Ù„Ø§Øª Ù…Ø§Ù„ÙŠØ© (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©)
st.sidebar.subheader("ğŸ’µ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (USD)")
diesel_price = st.sidebar.number_input("Ø³Ø¹Ø± Ù„ØªØ± Ø§Ù„Ø¯ÙŠØ²Ù„ ($)", 0.1, 5.0, 1.0)
h2_price = st.sidebar.number_input("Ø³Ø¹Ø± ÙƒØ¬Ù… Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ† ($)", 1.0, 50.0, 15.0)
dg_capex = st.sidebar.number_input("Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ($)", 1000, 50000, 5000)
logistics_cost = st.sidebar.slider("ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ§Øª ÙˆØ§Ù„Ù†Ù‚Ù„ %", 0, 50, 10, help="Ù†Ø³Ø¨Ø© Ù…Ø¦ÙˆÙŠØ© ØªØ¶Ø§Ù ÙƒØªÙƒÙ„ÙØ© Ù†Ù‚Ù„ ÙˆÙ‚ÙˆØ¯")

st.sidebar.markdown("---")

# --- 3. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Tabs) ---
st.title("ğŸ”‹ Fuel Cell vs Diesel Generator Analyzer")
st.markdown("Ù†Ø¸Ø§Ù… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ‰ Ø§Ù„ÙÙ†ÙŠØ© ÙˆØ§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠØ© Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù…ÙˆÙ„Ø¯Ø§Øª Ø¨Ø®Ù„Ø§ÙŠØ§ Ø§Ù„ÙˆÙ‚ÙˆØ¯.")

tabs = st.tabs(["ğŸ’° Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ‰ (ROI)", "ğŸ§® Ø­Ø§Ø³Ø¨Ø© Ø§Ù„ÙˆÙ‚ÙˆØ¯", "ğŸ“ ØªØµÙ…ÙŠÙ… Ø§Ù„Ù†Ø¸Ø§Ù…", "ğŸ“… Ø®Ø§Ø±Ø·Ø© Ø§Ù„Ø·Ø±ÙŠÙ‚", "ğŸ“š Ø§Ù„Ù…ØµØ§Ø¯Ø±"])

# --- TAB 1: Ø¯Ø±Ø§Ø³Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ‰ ÙˆØ§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯) ---
with tabs[0]:
    st.header("ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø¹Ø§Ø¦Ø¯ (TCO Analysis)")
    
    # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ù„ÙŠØ© Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
    valid_cells = [c for c in inventory if c.min_power <= load_kw <= c.max_power]
    if valid_cells:
        selected_fc = sorted(valid_cells, key=lambda x: x.efficiency, reverse=True)[0]
        
        # --- 1. Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯ (Diesel Generator) ---
        dg_efficiency = 0.3 # Ù„ØªØ±/ÙƒÙŠÙ„ÙˆÙˆØ§Ø· Ø³Ø§Ø¹Ø© (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
        dg_fuel_consumption_annual = load_kw * hours_per_year * dg_efficiency # Ù„ØªØ± ÙÙŠ Ø§Ù„Ø³Ù†Ø©
        dg_fuel_cost = dg_fuel_consumption_annual * diesel_price
        dg_maintenance = 0.5 * hours_per_year # ÙØ±Ø¶ÙŠØ©: 0.5 Ø¯ÙˆÙ„Ø§Ø± Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø© ØªØ´ØºÙŠÙ„ ØµÙŠØ§Ù†Ø©
        dg_co2 = dg_fuel_consumption_annual * 2.68 # 2.68 ÙƒØ¬Ù… ÙƒØ±Ø¨ÙˆÙ† Ù„ÙƒÙ„ Ù„ØªØ±
        
        dg_total_opex = dg_fuel_cost + dg_maintenance
        
        # --- 2. Ø­Ø³Ø§Ø¨Ø§Øª Ø®Ù„ÙŠØ© Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Fuel Cell) ---
        fc_energy_needed = load_kw * hours_per_year
        fc_fuel_mass = fc_energy_needed / selected_fc.efficiency / selected_fc.lhv
        fc_fuel_cost = fc_fuel_mass * h2_price
        fc_fuel_cost_with_logistics = fc_fuel_cost * (1 + logistics_cost/100)
        fc_maintenance = 0.05 * hours_per_year # ØµÙŠØ§Ù†Ø© Ø§Ù„Ø®Ù„ÙŠØ© Ø£Ù‚Ù„ Ø¨Ù€ 90% Ù…Ù† Ø§Ù„Ù…ÙˆÙ„Ø¯
        fc_capex = selected_fc.capex_per_kw * load_kw
        
        fc_total_opex = fc_fuel_cost_with_logistics + fc_maintenance

        # --- 3. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ---
        
        # Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Metrics)